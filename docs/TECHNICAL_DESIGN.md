# AgentPPT 技术设计文档

## 1. 项目概述

AgentPPT 是一个基于大模型 Agent 的 PPT 创建与编辑工具。用户通过自然语言描述需求，Agent 完成 PPT 的生成与修改；编辑时提供类似 Cursor 的交互体验：实时预览、同意/取消单次修改、多版本保存与恢复。

- **产品形态**：本地运行的单用户 Web 应用（多用户/权限留待后续）。
- **开源**：项目将发布在 GitHub 上。

---

## 2. 功能范围

### 2.1 PPT 创建

- 用户输入**主题**，Agent 生成大纲与各页内容。
- 支持上传**辅助材料**（如与主题相关的 Word 文档）以辅助生成；首版材料解析从简（如仅提取文本）。
- **两种模式**：
  - **无模板模式**：仅根据主题与材料生成内容，版式由规则或 Agent 决定。
  - **有模板模式**：用户上传 .pptx 模板（或从预设选择），Agent 在模板占位符内填充内容，保留版式与母版；模板在实现上可归类为一种「辅助材料」类型。

### 2.2 PPT 编辑

- 用户输入**编辑提示词**（自然语言），Agent 理解当前 PPT 后输出修改，结果在界面中**实时展示**。
- **同意修改**：用户确认后，本次修改持久化并形成新版本。
- **取消修改**：回退到本次编辑前的状态（首版仅支持「最近一次编辑」的单步回退）。
- **多版本**：支持保存多个版本（如版本 1 / 2 / 3），用户可选择恢复到某一版本。
- **编辑进行中**：不允许并发编辑，一次编辑未结束前不接收新编辑指令。

### 2.3 内容范围与优先级

| 优先级 | 内容           | 说明 |
|--------|----------------|------|
| **P0** | 文字、简单形状/排版 | 标题、正文、列表、备注、占位符、基本形状；首版必须支持。 |
| **P1** | 图片           | 插入、替换、简单裁剪；第二阶段。 |
| **P2** | 图表           | 柱状图、饼图、折线图等；第三阶段。 |
| **P3** | 动画与过渡     | 在文字/形状/图片/图表稳定后再支持。 |

内容范围无需一次性全部实现，按优先级逐步完善。

---

## 3. 技术栈

### 3.1 后端

| 项目     | 选型              | 说明 |
|----------|-------------------|------|
| 语言     | Python 3.10+      | 与 LangChain、python-pptx 生态一致。 |
| Web 框架 | FastAPI           | 异步、自动 OpenAPI、便于与前端对接。 |
| Agent 框架 | LangChain       | 编排创建/编辑链；后续可引入 LangGraph 做多步与工具。 |
| PPT 读写 | python-pptx       | 创建、解析、应用编辑指令；预览图生成可配合其他方案。 |
| 大模型   | 通过环境变量配置 API Key；具体 API 抽象为可切换的 LLM 提供方。 |

### 3.2 前端

| 项目     | 选型              | 说明 |
|----------|-------------------|------|
| 框架     | Vue 3              | 组件化，适合缩略图列表、大图、版本列表等界面。 |
| 语言     | TypeScript         | 类型安全，便于维护开源项目。 |
| 状态/请求 | 可选用 Pinia + 请求封装（如 axios） | 管理当前版本、当前页、编辑中状态等。 |

### 3.3 预览渲染（首版）

- 目标：**缩略图列表 + 当前页大图**；当前页暂不做在线编辑。
- 方案：**服务端将 .pptx 转为图片**，前端展示图片。
  - Windows：可使用 `comtypes` / `win32com` 调用本地 PowerPoint 将每页导出为 PNG。
  - 跨平台：可使用 LibreOffice Headless（`--headless --convert-to png`）按页或整份转换后裁剪。
- 「实时」含义：每次 Agent 修改并生成新 .pptx 后，后端重新导出该版本的页面图片，前端按版本刷新缩略图与当前页大图。

### 3.4 配置与运行

- **API Key**：从环境变量读取，由部署者配置。
- **运行方式**：本地启动后端服务 + 前端静态资源（或 dev server），单机单用户使用。

---

## 4. 架构设计

### 4.1 系统分层

```
┌─────────────────────────────────────────────────────────┐
│                    前端 (Vue 3 + TS)                     │
│  创建页 | 编辑页(缩略图+大图+提示词+同意/取消) | 版本列表  │
└─────────────────────────┬───────────────────────────────┘
                          │ HTTP / WebSocket(可选)
┌─────────────────────────▼───────────────────────────────┐
│                  后端 API (FastAPI)                      │
│  创建 | 编辑 | 版本管理 | 预览图导出 | 材料上传/解析       │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│                  Agent 层 (LangChain)                    │
│  创建链(主题+材料→大纲→内容) | 编辑链(提示词+上下文→指令) │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│              PPT 服务层 (python-pptx / 渲染)             │
│  读写 pptx | 执行编辑指令 | 导出预览图 | 版本持久化       │
└─────────────────────────────────────────────────────────┘
```

### 4.2 编辑「落地」方式（首版）

采用**结构化编辑指令**方式：

- Agent（LangChain 编辑链）根据用户提示词与当前 PPT 上下文，输出**一次编辑对应的 JSON 指令列表**。
- 后端对 JSON 做校验后，由**编辑执行器**用 python-pptx 按指令逐条执行，得到新 .pptx。
- 为后续扩展预留：可增加「按页替换 slide XML」的执行器（利用 LLM 的编码能力直接改 OOXML），与当前执行器并存，通过配置或策略选择。

**首版指令类型示例（P0）**：

- `set_text`：指定页、形状/占位符标识、新文本。
- `set_title`：指定页的标题占位符内容。
- `set_body`：指定页的正文占位符或某文本框内容。
- `add_bullet` / `set_bullets`：指定页某形状的列表内容。

形状标识可采用：`shape.name`、占位符类型（title, body 等）+ 序号，或解析时分配的稳定 ID（如 `slide_0_title`）。给 Agent 的上下文中需包含当前页（及必要时前后页）的形状列表与当前文本，便于生成正确指令。

### 4.3 上下文与 Token 控制（编辑）

- **必送**：PPT 的**结构化摘要**（每页页码、标题、要点、是否有图/表、备注等），便于模型理解整体。
- **必送**：**当前操作页的详细内容**（完整文字、形状文本等），便于精确修改。
- **按需**：若模型需引用或修改其他页，可通过 Tool 请求「第 N 页的详细内容」或「第 N 页的形状树」，避免一次性塞满 context。

### 4.4 同意/取消与版本

- **同意**：将当前「未确认的编辑结果」持久化为新版本（如版本号递增），并重新导出该版本的预览图；前端更新版本列表与当前展示。
- **取消**：丢弃未确认的编辑，从「已确认版本」重新加载 .pptx 与预览图；若已有预览图缓存可直接复用。
- **多版本**：每个版本对应一份 .pptx 及该版本的预览图；恢复某版本时，将其设为目标版本并重新导出预览（若无缓存）。

### 4.5 数据与存储（首版）

- 以「项目」为维度：每个项目一个目录或一条主记录，其下挂接多个版本的 .pptx 与对应预览图。
- 当前编辑态可在内存或临时文件中维护；用户点击「同意」后落盘为新版本。
- 辅助材料（Word、模板 pptx 等）上传后存于项目下，解析结果可缓存供 Agent 使用。

---

## 5. 接口与流程概要

### 5.1 创建流程

1. 用户提交：主题、创建模式（有无模板）、可选辅助材料（文件上传）。
2. 后端解析材料（首版从简），调用创建链，得到大纲与各页内容描述。
3. 后端使用 python-pptx 生成 .pptx（无模板时按规则排版；有模板时按占位符填充）。
4. 导出首版预览图，返回项目 ID 与版本信息；前端进入编辑页。

### 5.2 编辑流程

1. 用户打开某项目的某版本，前端拉取该版本预览图列表与当前页大图。
2. 用户输入编辑提示词并提交；后端在编辑中期间拒绝新的编辑请求。
3. 后端组装上下文（摘要 + 当前页详情），调用编辑链，得到 JSON 指令列表。
4. 后端校验并执行指令，生成「未确认」的新 .pptx，导出新预览图并返回前端。
5. 前端展示新预览；用户可选择「同意」或「取消」。
6. 同意：后端将新 .pptx 存为新版本，更新版本列表与预览；取消：后端丢弃未确认结果，前端恢复为上一版本展示。

### 5.3 版本恢复

- 用户从版本列表选择「恢复到版本 K」；后端将版本 K 的 .pptx 设为当前版本，并返回或生成该版本的预览图；前端刷新展示。

---

## 6. 安全与约束

- API Key 仅在后端使用，不暴露给前端。
- 上传材料需做类型与大小限制，解析时避免执行或解析不可信代码。
- 若后续支持「LLM 直接改 XML」，需对 LLM 输出的 XML 做校验（如 schema、必选节点），并在重打包后做一次「可打开」校验，失败则回退并提示。

---

## 7. 后续演进方向

- **流式/分步预览**：编辑过程中按页或按块流式返回结果并更新预览。
- **当前页在线编辑**：当前页支持直接编辑，与 Agent 编辑协同。
- **LLM 直接改 OOXML**：在单页粒度下，由 LLM 输出修改后的 slide XML，经校验后替换并重打包，以支持 python-pptx 难以表达的动画、版式等。
- **多用户与权限**：账号、项目归属、协作与权限控制。
- **内容范围**：按 P1→P2→P3 逐步支持图片、图表、动画与过渡。

---

## 8. 文档维护

- 本文档随迭代更新，重大架构变更需同步修改并注明日期与版本。
